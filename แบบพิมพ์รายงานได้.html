<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อความฝ่ายบุคคล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f7ff; }
        .form-card { box-shadow: 0 4px 20px rgba(30, 64, 175, 0.08); border: 1px solid #e0e7ff; }
        .table-container { overflow-x: auto; }
        .edit-mode-active { border: 2px solid #2563eb; background-color: #f8faff; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #bfdbfe; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        .search-input {
            transition: all 0.3s;
            border: 1px solid #cbd5e1;
        }
        .search-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            background-color: white;
        }
        .header-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }

        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto no-print">
        <!-- Header -->
        <div class="text-center mb-10 p-8 rounded-3xl header-gradient shadow-lg shadow-blue-200">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">ระบบบันทึกข้อความฝ่ายบุคคล</h1>
            <p class="text-blue-100 text-lg opacity-90">โรงเรียนบ้านดุซงยอ</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Form Section -->
            <div class="lg:col-span-1">
                <div id="formContainer" class="bg-white rounded-2xl p-6 form-card sticky top-8 transition-all duration-300">
                    <div class="flex justify-between items-center mb-6 border-b border-blue-50 pb-3">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-6 bg-blue-600 rounded-full"></div>
                            <h2 id="formTitle" class="text-xl font-bold text-slate-800">ลงทะเบียนใหม่</h2>
                        </div>
                        <button id="cancelEditBtn" class="hidden text-sm text-red-500 hover:text-red-700 font-medium">ยกเลิก</button>
                    </div>
                    
                    <form id="memoForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">เลขที่บันทึก</label>
                            <input type="text" id="memoId" name="memoId" readonly
                                class="w-full px-4 py-2 bg-blue-50 border border-blue-100 rounded-xl text-blue-700 font-bold outline-none">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">ลงวันที่ <span class="text-red-500">*</span></label>
                            <input type="date" id="dateInput" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none mb-2">
                            <input type="text" id="displayDate" readonly class="w-full px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl text-slate-500 text-sm outline-none">
                            <input type="hidden" id="fullDateFormatted" name="date">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">เรื่อง <span class="text-red-500">*</span></label>
                            <input type="text" id="subject" name="subject" required class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-300" placeholder="ระบุชื่อเรื่อง...">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">ผู้รับผิดชอบ <span class="text-red-500">*</span></label>
                            <input type="text" id="responsible" name="responsible" required class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-300" placeholder="ชื่อ-นามสกุล...">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-1">หมายเหตุ</label>
                            <textarea id="note" name="note" rows="2" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none placeholder:text-slate-300" placeholder="ข้อมูลเพิ่มเติม (ถ้ามี)"></textarea>
                        </div>

                        <div id="statusMsg" class="hidden p-3 rounded-xl text-center text-sm font-medium"></div>

                        <button type="submit" id="submitBtn" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3.5 px-6 rounded-xl shadow-lg shadow-blue-100 transition-all active:scale-[0.98] mt-2">
                            บันทึกข้อมูล
                        </button>
                    </form>
                </div>
            </div>

            <!-- Table Section -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-3xl p-6 form-card min-h-[550px] relative border border-blue-50">
                    <div id="tableLoader" class="loading-overlay absolute inset-0 rounded-3xl hidden flex flex-col items-center justify-center bg-white/90 z-20">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-600 mb-4"></div>
                        <p class="text-blue-600 font-medium">กำลังโหลดข้อมูล...</p>
                    </div>

                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-blue-600 rounded-lg shadow-blue-200 shadow-md">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800">รายการที่บันทึกแล้ว</h2>
                            </div>
                            <span id="recordCount" class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold tracking-wider ml-2">0</span>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto items-center">
                            <button onclick="fetchDataFromSheet()" class="p-2.5 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-xl transition-all" title="รีเฟรชข้อมูล">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>

                            <button onclick="printSummaryTable()" class="flex items-center space-x-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold transition-all shadow-md shadow-emerald-100 w-full sm:w-auto">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                <span>พิมพ์รายงานสรุป (แนวตั้ง)</span>
                            </button>

                            <div class="relative w-full md:w-64">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3.5">
                                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                </span>
                                <input type="text" id="searchInput" placeholder="ค้นหา..." 
                                    class="search-input w-full pl-11 pr-4 py-2.5 rounded-2xl text-sm outline-none bg-blue-50/50">
                            </div>
                        </div>
                    </div>

                    <div class="table-container rounded-2xl border border-blue-50">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-blue-600 text-white">
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-[15%] rounded-tl-2xl">เลขที่</th>
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-[20%]">วันที่</th>
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-[35%]">เรื่อง</th>
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-[20%] text-center">ผู้รับผิดชอบ</th>
                                    <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider text-center w-[10%] rounded-tr-2xl">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="memoList" class="divide-y divide-blue-50 text-sm"></tbody>
                        </table>
                    </div>

                    <div id="emptyState" class="hidden text-center py-24 text-slate-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                        <p class="text-lg mb-2">ไม่พบข้อมูลในระบบ</p>
                    </div>

                    <div id="errorState" class="hidden text-center py-24 text-rose-500">
                        <p class="text-lg font-bold mb-2">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                        <button onclick="fetchDataFromSheet()" class="px-6 py-2 bg-rose-100 text-rose-600 rounded-xl font-bold hover:bg-rose-200 transition-all">ลองใหม่อีกครั้ง</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-16 mb-12 text-center">
            <div class="inline-block px-6 py-2 bg-blue-100/50 rounded-full border border-blue-200">
                <p class="text-blue-700 font-medium text-sm">จัดทำโดย นายวุฒนันท์ เจ๊ะดาโอะ</p>
            </div>
        </div>
    </div>

    <script>
        const START_YEAR = 2569;
        const PREFIX = "บค.";
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzf2fKCixbYXvz2pc4dm3zpq9AIi-I5Zebv0Bgs8RJhjIql22R5iav2w9SY2kkF1jVEgw/exec";

        let currentRecords = [];
        let isEditMode = false;

        // ฟังก์ชันช่วยจัดการวันที่ให้แสดงเป็น พ.ศ. เสมอ
        function formatThaiDate(dateInput) {
            if (!dateInput) return "-";
            
            let dateObj;
            if (dateInput instanceof Date) {
                dateObj = dateInput;
            } else if (typeof dateInput === 'string') {
                // ตรวจสอบว่าเป็น ISO String หรือไม่
                dateObj = new Date(dateInput);
            }

            if (isNaN(dateObj.getTime())) return dateInput;

            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const day = dateObj.getDate();
            const month = months[dateObj.getMonth()];
            
            // ดึงปี ค.ศ.
            let year = dateObj.getFullYear();
            
            // ป้องกันการบวกปีซ้ำซ้อน: ถ้าปีที่ได้มีค่ามากกว่า 2400 แสดงว่าเป็น พ.ศ. อยู่แล้ว
            let thaiYear = year < 2400 ? year + 543 : year;
            
            return `${day} ${month} ${thaiYear}`;
        }

        async function fetchDataFromSheet() {
            const loader = document.getElementById('tableLoader');
            const errorView = document.getElementById('errorState');
            const emptyView = document.getElementById('emptyState');
            
            loader.classList.remove('hidden');
            errorView.classList.add('hidden');
            emptyView.classList.add('hidden');

            try {
                const response = await fetch(`${WEB_APP_URL}?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Network error');
                currentRecords = await response.json();
                filterAndRender();
                if (!isEditMode) updateNextMemoId();
            } catch (error) {
                console.error(error);
                errorView.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }

        function updateNextMemoId() {
            let maxNum = 0;
            if (currentRecords && Array.isArray(currentRecords)) {
                currentRecords.forEach(rec => {
                    if (rec.memoId && typeof rec.memoId === 'string' && rec.memoId.includes('/')) {
                        const numPart = rec.memoId.split('/')[0].replace(PREFIX, '');
                        const num = parseInt(numPart);
                        if (!isNaN(num) && num > maxNum) maxNum = num;
                    }
                });
            }
            document.getElementById('memoId').value = `${PREFIX}${maxNum + 1}/${START_YEAR}`;
        }

        function filterAndRender() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = currentRecords.filter(item => {
                return (
                    (item.memoId && String(item.memoId).toLowerCase().includes(searchTerm)) ||
                    (item.subject && String(item.subject).toLowerCase().includes(searchTerm)) ||
                    (item.responsible && String(item.responsible).toLowerCase().includes(searchTerm))
                );
            });
            renderTable(filtered);
        }

        function renderTable(records) {
            const listBody = document.getElementById('memoList');
            document.getElementById('recordCount').innerText = records.length;
            listBody.innerHTML = '';

            if (!records || records.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                [...records].reverse().forEach(item => {
                    const row = `
                        <tr class="hover:bg-blue-50 transition-colors border-b border-blue-50 last:border-0">
                            <td class="px-5 py-4 font-bold text-blue-700">${item.memoId || '-'}</td>
                            <td class="px-5 py-4 text-slate-500 font-light">${formatThaiDate(item.date)}</td>
                            <td class="px-5 py-4 text-slate-700 font-medium">${item.subject || '-'}</td>
                            <td class="px-5 py-4 text-center">
                                <span class="px-2 py-1 bg-blue-100/50 rounded-lg text-xs font-semibold text-blue-600">${item.responsible || '-'}</span>
                            </td>
                            <td class="px-5 py-4 text-center">
                                <button onclick="startEdit('${item.memoId}')" class="text-blue-600 hover:bg-blue-100 p-2 rounded-lg transition-colors" title="แก้ไข">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </button>
                            </td>
                        </tr>
                    `;
                    listBody.insertAdjacentHTML('beforeend', row);
                });
            }
        }

        function printSummaryTable() {
            if (currentRecords.length === 0) return;
            const printWin = window.open('', '_blank');
            const sortedRecords = [...currentRecords].sort((a, b) => {
                const numA = parseInt(String(a.memoId).split('/')[0].replace(PREFIX, '')) || 0;
                const numB = parseInt(String(b.memoId).split('/')[0].replace(PREFIX, '')) || 0;
                return numA - numB;
            });

            const rowsHtml = sortedRecords.map((item, idx) => `
                <tr>
                    <td style="text-align:center;">${idx + 1}</td>
                    <td style="text-align:center;">${item.memoId}</td>
                    <td style="text-align:center;">${formatThaiDate(item.date)}</td>
                    <td>${item.subject}</td>
                    <td style="text-align:center;">${item.responsible}</td>
                </tr>
            `).join('');

            printWin.document.write(`
                <html>
                <head>
                    <title>รายงานทะเบียนบันทึกข้อความ</title>
                    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Sarabun', sans-serif; padding: 1.5cm; }
                        .header { text-align: center; margin-bottom: 25px; }
                        table { width: 100%; border-collapse: collapse; font-size: 13px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2 style="margin:0">ทะเบียนคุมบันทึกข้อความฝ่ายบริหารงานบุคคล</h2>
                        <div style="font-size:16px">โรงเรียนบ้านดุซงยอ</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th width="5%">ที่</th>
                                <th width="15%">เลขที่บันทึก</th>
                                <th width="20%">ลงวันที่</th>
                                <th>เรื่อง</th>
                                <th width="20%">ผู้รับผิดชอบ</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                    <script>window.onload = () => { window.print(); window.onafterprint = () => window.close(); };<\/script>
                </body>
                </html>
            `);
            printWin.document.close();
        }

        function startEdit(memoId) {
            const record = currentRecords.find(r => r.memoId === memoId);
            if (!record) return;

            isEditMode = true;
            document.getElementById('formTitle').innerText = "แก้ไขข้อมูล";
            document.getElementById('formContainer').classList.add('edit-mode-active');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('submitBtn').innerText = "บันทึกการแก้ไข";

            document.getElementById('memoId').value = record.memoId;
            document.getElementById('subject').value = record.subject;
            document.getElementById('responsible').value = record.responsible;
            document.getElementById('note').value = record.note || '';
            
            // แปลงวันที่กลับเป็นรูปแบบ input date (yyyy-mm-dd)
            if (record.date) {
                const dateParts = record.date.split(' '); // สมมติถ้าเก็บเป็น "18 กุมภาพันธ์ 2569"
                // แต่เพื่อความชัวร์ เราจะพยายามดึงจาก dateObj ถ้ามี
                const d = new Date(record.date);
                if (!isNaN(d.getTime())) {
                    document.getElementById('dateInput').value = d.toISOString().split('T')[0];
                }
                document.getElementById('displayDate').value = formatThaiDate(record.date);
                document.getElementById('fullDateFormatted').value = formatThaiDate(record.date);
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.getElementById('cancelEditBtn').onclick = () => {
            isEditMode = false;
            document.getElementById('memoForm').reset();
            document.getElementById('formTitle').innerText = "ลงทะเบียนใหม่";
            document.getElementById('formContainer').classList.remove('edit-mode-active');
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('submitBtn').innerText = "บันทึกข้อมูล";
            setCurrentDate();
            updateNextMemoId();
        };

        const dateInput = document.getElementById('dateInput');
        const displayDate = document.getElementById('displayDate');
        const fullDateFormatted = document.getElementById('fullDateFormatted');

        function setCurrentDate() {
            const now = new Date();
            dateInput.value = now.toISOString().split('T')[0];
            const thai = formatThaiDate(now);
            displayDate.value = thai;
            fullDateFormatted.value = thai;
        }

        dateInput.addEventListener('change', (e) => {
            const d = new Date(e.target.value);
            if (!isNaN(d.getTime())) {
                const thai = formatThaiDate(d);
                displayDate.value = thai;
                fullDateFormatted.value = thai;
            }
        });

        window.onload = () => {
            setCurrentDate();
            fetchDataFromSheet();
        };

        document.getElementById('memoForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "กำลังประมวลผล...";
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            const params = new URLSearchParams();
            for (const key in data) {
                params.append(key, data[key]);
            }

            try {
                await fetch(`${WEB_APP_URL}?${params.toString()}`, { method: 'POST', mode: 'no-cors' });
                showStatus(isEditMode ? "ปรับปรุงสำเร็จ" : "บันทึกสำเร็จ", "success");
                setTimeout(() => {
                    if (isEditMode) document.getElementById('cancelEditBtn').click();
                    else { e.target.reset(); setCurrentDate(); }
                    fetchDataFromSheet();
                    btn.disabled = false;
                    document.getElementById('statusMsg').classList.add('hidden');
                }, 1000);
            } catch (error) {
                showStatus("เกิดข้อผิดพลาด", "error");
                btn.disabled = false;
            }
        };

        function showStatus(msg, type) {
            const s = document.getElementById('statusMsg');
            s.innerText = msg;
            s.className = `p-3 rounded-xl text-center text-sm font-medium ${type === 'success' ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'}`;
            s.classList.remove('hidden');
        }

        document.getElementById('searchInput').addEventListener('input', filterAndRender);
    </script>
</body>
</html>